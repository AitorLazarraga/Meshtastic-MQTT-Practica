import numpy as np
import base64
import serial
import time
import matplotlib.pyplot as plt

def generate_sine_wave(frequency, duration, sampling_rate):
    """
    Genera una señal seno con parámetros dados.
    :param frequency: Frecuencia de la señal en Hz.
    :param duration: Duración de la señal en segundos.
    :param sampling_rate: Tasa de muestreo en Hz.
    :return: Señal seno como un array numpy.
    """
    t = np.linspace(0, duration, int(sampling_rate * duration), endpoint=False)
    sine_wave = np.sin(2 * np.pi * frequency * t)
    return sine_wave



    #ecg_wave = np.array([0.3743016759776536, 0.3743016759776536, 0.3743016759776536, 0.3798882681564246, 0.38547486033519557, 0.38547486033519557, 0.38547486033519557, 0.38547486033519557, 0.3910614525139665, 0.388268156424581, 0.39664804469273746, 0.3994413407821229, 0.3994413407821229, 0.39664804469273746, 0.393854748603352, 0.388268156424581, 0.388268156424581, 0.3798882681564246, 0.3770949720670391, 0.3687150837988827, 0.3687150837988827, 0.38268156424581007, 0.39664804469273746, 0.40223463687150834, 0.3994413407821229, 0.40223463687150834, 0.39664804469273746, 0.3910614525139665, 0.3910614525139665, 0.39664804469273746, 0.3910614525139665, 0.39664804469273746, 0.393854748603352, 0.39664804469273746, 0.39664804469273746, 0.393854748603352, 0.39664804469273746, 0.39664804469273746, 0.3994413407821229, 0.39664804469273746, 0.393854748603352, 0.3994413407821229, 0.3994413407821229, 0.393854748603352, 0.393854748603352, 0.3910614525139665, 0.393854748603352, 0.40223463687150834, 0.40502793296089384, 0.4106145251396648, 0.4273743016759777, 0.4245810055865922, 0.43575418994413406, 0.44134078212290506, 0.4273743016759777, 0.4078212290502793, 0.3910614525139665, 0.3798882681564246, 0.3770949720670391, 0.3743016759776536, 0.3687150837988827, 0.3715083798882682, 0.3687150837988827, 0.3715083798882682, 0.3770949720670391, 0.36033519553072624, 0.3687150837988827, 0.43854748603351956, 0.6675977653631285, 0.9078212290502793, 0.5139664804469274, 0.16480446927374304, 0.18435754189944134, 0.3016759776536313, 0.3575418994413408, 0.36312849162011174, 0.36592178770949724, 0.36592178770949724, 0.36592178770949724, 0.36592178770949724, 0.36592178770949724, 0.3687150837988827, 0.3743016759776536, 0.3743016759776536, 0.3715083798882682, 0.3743016759776536, 0.38268156424581007, 0.38547486033519557, 0.38547486033519557, 0.388268156424581, 0.3910614525139665, 0.393854748603352, 0.3910614525139665, 0.3910614525139665, 0.38547486033519557, 0.38268156424581007, 0.3743016759776536, 0.36592178770949724, 0.36033519553072624, 0.3575418994413408, 0.36592178770949724, 0.3743016759776536, 0.38547486033519557, 0.3910614525139665, 0.393854748603352, 0.393854748603352, 0.3910614525139665, 0.38268156424581007, 0.38268156424581007, 0.38268156424581007, 0.388268156424581, 0.388268156424581, 0.388268156424581, 0.388268156424581, 0.388268156424581, 0.38547486033519557, 0.388268156424581, 0.38547486033519557, 0.38547486033519557, 0.38547486033519557, 0.388268156424581, 0.388268156424581, 0.38268156424581007, 0.3798882681564246, 0.3798882681564246, 0.3770949720670391, 0.3798882681564246, 0.38547486033519557, 0.39664804469273746, 0.3994413407821229, 0.41620111731843573, 0.41620111731843573, 0.4245810055865922, 0.4245810055865922, 0.4301675977653631, 0.4078212290502793, 0.393854748603352, 0.3770949720670391, 0.36592178770949724, 0.36033519553072624, 0.36033519553072624, 0.3575418994413408, 0.3547486033519553, 0.36033519553072624, 0.36033519553072624, 0.3575418994413408, 0.34636871508379885, 0.388268156424581, 0.5223463687150838, 0.8128491620111732, 0.9050279329608939, 0.3715083798882682, 0.12849162011173187, 0.22625698324022347, 0.32402234636871513, 0.35195530726256985, 0.35195530726256985, 0.35195530726256985, 0.3547486033519553, 0.3547486033519553, 0.36033519553072624, 0.3575418994413408, 0.36033519553072624, 0.36033519553072624, 0.36033519553072624, 0.36592178770949724, 0.36592178770949724, 0.3687150837988827, 0.3687150837988827, 0.3715083798882682, 0.3798882681564246, 0.3770949720670391, 0.3798882681564246, 0.3798882681564246, 0.38268156424581007, 0.3770949720670391, 0.3715083798882682, 0.3687150837988827, 0.36312849162011174, 0.36033519553072624, 0.3547486033519553, 0.3575418994413408, 0.36033519553072624, 0.3743016759776536, 0.3798882681564246, 0.38268156424581007, 0.3798882681564246, 0.3770949720670391, 0.3743016759776536, 0.3687150837988827, 0.3715083798882682, 0.3715083798882682, 0.3743016759776536, 0.3743016759776536, 0.3770949720670391, 0.3770949720670391, 0.3715083798882682, 0.3715083798882682, 0.3770949720670391, 0.3770949720670391, 0.3770949720670391, 0.3743016759776536, 0.3743016759776536, 0.3687150837988827, 0.3715083798882682, 0.3743016759776536, 0.36592178770949724, 0.3798882681564246, 0.38547486033519557, 0.3910614525139665, 0.40502793296089384, 0.40223463687150834, 0.41620111731843573, 0.4106145251396648, 0.41620111731843573, 0.3910614525139665, 0.38268156424581007, 0.36592178770949724, 0.3547486033519553, 0.34916201117318435, 0.3575418994413408, 0.34636871508379885, 0.34916201117318435, 0.35195530726256985, 0.3547486033519553, 0.34636871508379885, 0.34636871508379885, 0.4134078212290503, 0.6424581005586592, 0.9441340782122905, 0.6424581005586592, 0.1871508379888268, 0.16480446927374304, 0.2877094972067039, 0.3435754189944134, 0.34916201117318435, 0.34916201117318435, 0.34636871508379885, 0.35195530726256985, 0.35195530726256985, 0.34636871508379885, 0.35195530726256985, 0.3575418994413408, 0.35195530726256985, 0.3547486033519553, 0.36312849162011174, 0.36592178770949724, 0.36592178770949724, 0.36592178770949724, 0.3687150837988827, 0.3743016759776536, 0.3715083798882682, 0.3715083798882682, 0.3743016759776536, 0.3770949720670391, 0.3743016759776536])
    ecg_wave = np.array([254,128,140,147,144,132,252,253,133,141,146,146,137,250,234,223,219,223,230,239,247,252,129,137,147,156,161,157,149,143,143,145,147,149,148,140,129,248,245,245,244,245,249,129,137,144,150,153,153,151,146,137,253,242,236,239,251,138,148,147,136,246,230,221,223,233,248,137,149,153,152,151,151,149,139,251,233,219,215,223,240,129,135,131,251,244,241,243,245,244,242,242,246,254,136,141,140,131,244,228,216,215,223,237,248,254,131,132,130,253,248,244,244,247,251,128,134,138,137,132,250,241,235,234,239,244,249,253,252,247,239,230,220,214,219,233,250,135,143,148,148,142,130,247,239,234,233,239,245,248,249,254,135,141,144,143,138,130,248,239,232,233,241,251,128,128,254,252,250,249,245,240,237,239,247,131,142,145,140,128,240,227,220,222,231,243,250,254,130,131,131,131,128,251,249,249,252,129,133,135,138,143,150,154,154,146,134,252,249,252,252,245,238,233,230,227,224,224,230,240,251,132,134,133,132,132,127,246,238,234,236,245,132,145,150,148,142,134,252,244,239,236,237,242,249,253,251,246,244,245,249,254,254,249,242,240])



def initialize_serial_port(port, baudrate=115200, timeout=1):
    """
    Inicializa y devuelve un objeto de puerto serie.
    :param port: Puerto serie al que se conectará.
    :param baudrate: Velocidad de transmisión en baudios.
    :param timeout: Tiempo de espera para la comunicación serie.
    :return: Objeto serial.Serial.
    """
    try:
        ser = serial.Serial(port, baudrate, timeout=timeout)
        return ser
    except serial.SerialException as e:
        print(f"Error al abrir el puerto serie: {e}")
        return None
def encode_wave_base64(sine_wave):
    """
    Codifica una señal seno en formato Base64.
    :param sine_wave: Array numpy representando la señal seno.
    :return: Cadena codificada en Base64.
    """
    sine_bytes = sine_wave.astype(np.float32).tobytes() # Convertir a bytes
    base64_encoded = base64.b64encode(sine_bytes).decode('utf-8') # Codificar en Base64
    return base64_encoded

def split_into_packets(data, packet_size):
    """
    Divide los datos en paquetes de tamaño especificado.
    :param data: Lista o array de datos.
    :param packet_size: Tamaño del paquete.
    :return: Lista de paquetes.
    """
    for i in range(0, len(data), packet_size):
        yield data[i:i+packet_size]

    '''def transmit_via_serial(data_packets, port, baudrate=115200):
    """
    Transmite datos por un puerto serie en paquetes.
    :param data_packets: Lista de paquetes de datos a transmitir.
    :param port: Puerto serie al que se conectará.
    :param baudrate: Velocidad de transmisión en baudios.
    """
    try:
    i = 0
    with serial.Serial(port, baudrate, timeout=1) as ser:
    for packet in data_packets:
    encoded_packet = encode_wave_base64(packet)
    indexed_package = str(i) + encoded_packet + "\n"
    ser.write(indexed_package.encode('utf-8')) # Enviar el paquete con un salto de línea
    print(f"Paquete transmitido: {indexed_package}")
    time.sleep(5) # Pausa entre paquetes para evitar saturación
    i = i + 1
    except serial.SerialException as e:
    print(f"Error al abrir el puerto serie: {e}")'''

def close_serial_port(ser):
    ser.close()
def transmit_via_serial(data_packets, ser):
    """
    Transmite datos por un puerto serie en paquetes.
    :param data_packets: Lista de paquetes de datos a transmitir.
    :param ser: Objeto serial.Serial inicializado.
    """
    if not ser:
        print("El puerto serie no está inicializado. No se puede transmitir.")
        return

    try:
        conta = 0
        for packet in data_packets:
            encoded_packet = encode_wave_base64(packet) # Asume que esta función está definida
            if conta <= 9:
                indexed_package = "0" + str(conta) + encoded_packet + "\n"
            else:
                indexed_package = str(conta) + encoded_packet + "\n"
                ser.write(indexed_package.encode('utf-8')) # Enviar el paquete con un salto de línea
                print(f"Paquete transmitido: {indexed_package}")
                time.sleep(5) # Pausa entre paquetes para evitar saturación
                conta += 1
    except Exception as e:
        print(f"Error durante la transmisión: {e}")
def init_transmit_via_serial(data_packets, ser):
    ser.write("Voy a probar".encode('utf-8'))
    time.sleep(3)

def end_transmit_via_serial(data_packets, ser):
    ser.write(data_packets.encode('utf-8'))
    time.sleep(3)


def plot_signal(signal):
    """
    Grafica la señal reconstruida.
    :param signal: Array numpy con la señal reconstruida.
    """
    plt.figure(figsize=(10, 5))
    plt.plot(signal, label="Reconstructed Signal", color="blue")
    plt.title("Reconstructed Signal from Base64 Packets")
    plt.xlabel("Sample Index")
    plt.ylabel("Amplitude")
    plt.legend()
    plt.grid(True)
    plt.show()

    if __name__ == "__main__":
    # Transmitir por el puerto serie
        serial_port = "/dev/ttyUSB0" # Cambiar según tu sistema operativo (e.g., "COM3" para Windows)
        baudrate = 115200

        ser = initialize_serial_port(serial_port, baudrate)
        init_transmit_via_serial(len_package, ser)
        # Envia la señal de ECG
        transmit_via_serial(data_packets, ser)

        end_transmit_via_serial("END...", ser) 
        close_serial_port(ser)
        #transmit_via_serial(signal_len, serial_port)
        #transmit_via_serial(packets, serial_port)
        #transmit_via_serial("END...", serial_port)

        # RX = 25 ----> Amarillo ----> RX
        # TX = 4 ----> Blanco ----> TX